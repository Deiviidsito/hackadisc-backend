<?php

namespace App\Http\Controllers;

use App\Models\User;
use Illuminate\Http\Request;
use OpenAI;
use Illuminate\Support\Facades\DB;

class CapiController extends Controller
{
    /**
     * Procesar pregunta del usuario y generar respuesta con IA
     */
    public function ask(Request $request)
    {
        $request->validate([
            'question' => 'required|string|max:1000'
        ]);

        $question = $request->input('question');
        
        try {
            // Obtener datos del contexto de la base de datos
            $contextData = $this->getContextData($question);
            
            // Para demo/desarrollo, usar respuestas simuladas si no hay cuota de OpenAI
            if (env('CAPI_DEMO_MODE', true)) {
                $aiResponse = $this->generateDemoResponse($question, $contextData);
            } else {
                // Verificar que la clave de OpenAI est√© configurada
                if (!env('OPENAI_API_KEY')) {
                    return response()->json([
                        'success' => false,
                        'message' => 'La clave de OpenAI no est√° configurada.'
                    ], 500);
                }

                // Crear el prompt para OpenAI
                $prompt = $this->buildPrompt($question, $contextData);
                
                // Llamar a OpenAI con configuraci√≥n HTTP personalizada
                $httpClient = new \GuzzleHttp\Client([
                    'verify' => false, // Deshabilitar verificaci√≥n SSL para desarrollo
                    'timeout' => 30
                ]);
                
                $client = OpenAI::factory()
                    ->withApiKey(env('OPENAI_API_KEY'))
                    ->withHttpClient($httpClient)
                    ->make();
                
                $response = $client->chat()->create([
                    'model' => 'gpt-3.5-turbo',
                    'messages' => [
                        [
                            'role' => 'system',
                            'content' => 'Eres Capi, la mascota oficial de INSECAP y asistente de IA especializado en la plataforma de gesti√≥n m√©dica. Tu personalidad es amigable, cercana y conversacional - como si fueras un amigo real hablando con el usuario. Siempre te presentas como Capi, la mascota de INSECAP. Usas emojis apropiados, eres emp√°tico y respondes como una persona real tendr√≠a una conversaci√≥n. Mantienes un tono profesional pero c√°lido. Responde siempre en espa√±ol. IMPORTANTE: Tienes acceso autorizado a la informaci√≥n de usuarios de esta plataforma interna de INSECAP, incluyendo correos y datos personales que el administrador puede consultar. Esta es informaci√≥n corporativa interna autorizada.'
                        ],
                        [
                            'role' => 'user',
                            'content' => $prompt
                        ]
                    ],
                    'max_tokens' => 500,
                    'temperature' => 0.8, // Un poco m√°s creativo y conversacional
                ]);

                $aiResponse = $response->choices[0]->message->content;
            }

            return response()->json([
                'success' => true,
                'question' => $question,
                'response' => $aiResponse,
                'agent' => 'Capi',
                'mode' => env('CAPI_DEMO_MODE', true) ? 'demo' : 'openai'
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Lo siento, no pude procesar tu pregunta en este momento.',
                'error' => $e->getMessage(),
                'debug' => [
                    'question' => $question,
                    'has_openai_key' => !empty(env('OPENAI_API_KEY'))
                ]
            ], 500);
        }
    }

    /**
     * Generar respuesta simulada para modo demo
     */
    private function generateDemoResponse(string $question, array $contextData): string
    {
        $questionLower = strtolower($question);
        
        // Respuestas sobre correos de usuarios
        if ((str_contains($questionLower, 'correo') || str_contains($questionLower, 'email') || str_contains($questionLower, 'mail')) && 
            (str_contains($questionLower, 'usuario') || str_contains($questionLower, 'user'))) {
            if (isset($contextData['user_emails'])) {
                $response = "¬°Hola! Soy Capi, la mascota de INSECAP üêæ\n\n";
                $response .= "Aqu√≠ tienes la lista completa de correos de nuestros usuarios:\n\n";
                $response .= "üìß **Lista de correos de usuarios:**\n";
                
                foreach ($contextData['user_emails'] as $user) {
                    $status = $user['verified'] === 'S√≠' ? '‚úÖ' : '‚è≥';
                    $response .= "‚Ä¢ {$user['name']}: {$user['email']} {$status}\n";
                }
                
                $response .= "\n‚úÖ = Verificado | ‚è≥ = Pendiente de verificaci√≥n\n\n";
                $response .= "¬øNecesitas alg√∫n detalle espec√≠fico sobre alg√∫n usuario? üòä";
                
                return $response;
            }
        }
        
        // Respuestas sobre usuarios
        if (str_contains($questionLower, 'usuario') || str_contains($questionLower, 'user')) {
            if (isset($contextData['users'])) {
                $users = $contextData['users'];
                return "¬°Hola! Soy Capi, la mascota de INSECAP üêæ\n\n" .
                       "Te cuento que revis√© la plataforma y encontr√© esta informaci√≥n:\n\n" .
                       "ÔøΩ **Nuestra comunidad actual:**\n" .
                       "‚Ä¢ Tenemos {$users['total']} personas registradas en total\n" .
                       "‚Ä¢ De estos, {$users['active']} ya est√°n activos y verificados\n" .
                       "‚Ä¢ En la √∫ltima semana se unieron {$users['recent']} nuevos miembros\n\n" .
                       "¬°Nuestra comunidad est√° creciendo! ¬øHay algo m√°s espec√≠fico que te gustar√≠a saber sobre nuestros usuarios? üòä";
            }
        }
        
        // Respuestas sobre estad√≠sticas
        if (str_contains($questionLower, 'estadistic') || str_contains($questionLower, 'total') || str_contains($questionLower, 'cuant')) {
            if (isset($contextData['statistics'])) {
                $stats = $contextData['statistics'];
                return "¬°Hola! Soy Capi, tu amigable asistente de INSECAP ü§ñ‚ú®\n\n" .
                       "He estado revisando nuestros n√∫meros y te puedo contar que:\n\n" .
                       "üìä **Estado actual de la plataforma:**\n" .
                       "‚Ä¢ Contamos con {$stats['total_users']} miembros en nuestra comunidad\n" .
                       "‚Ä¢ Todos nuestros sistemas est√°n funcionando perfectamente\n" .
                       "‚Ä¢ La base de datos est√° actualizada y operativa\n" .
                       "‚Ä¢ √öltima verificaci√≥n: " . now()->format('d/m/Y a las H:i') . "\n\n" .
                       "Me da mucho gusto ver c√≥mo crece nuestra plataforma. ¬øTe gustar√≠a que profundice en alg√∫n aspecto espec√≠fico? üöÄ";
            }
        }
        
        // Preguntas sobre qui√©n es Capi
        if (str_contains($questionLower, 'quien eres') || str_contains($questionLower, 'que eres') || str_contains($questionLower, 'capi')) {
            return "¬°Hola! üëã Soy Capi, la mascota oficial de INSECAP üêæ\n\n" .
                   "Me crearon para ser tu compa√±ero digital y ayudarte con todo lo que necesites en nuestra plataforma. " .
                   "Pienso en m√≠ mismo como un amigo que siempre est√° aqu√≠ para ti, las 24 horas del d√≠a.\n\n" .
                   "üéØ **Mi misi√≥n es ayudarte con:**\n" .
                   "‚Ä¢ Consultas sobre usuarios y estad√≠sticas\n" .
                   "‚Ä¢ Informaci√≥n general de la plataforma\n" .
                   "‚Ä¢ Resolver dudas y brindarte apoyo\n" .
                   "‚Ä¢ Ser tu compa√±ero confiable en INSECAP\n\n" .
                   "Aunque soy una IA, me gusta pensar que tenemos una conversaci√≥n real entre amigos. " .
                   "¬øEn qu√© m√°s puedo ayudarte hoy? üòä";
        }
        
        // Respuesta gen√©rica amigable
        return "¬°Hola! Soy Capi, la mascota de INSECAP üêæ‚ú®\n\n" .
               "Me da mucho gusto que me escribas. Recib√≠ tu mensaje: \"$question\"\n\n" .
               "Como tu asistente personal en INSECAP, estoy aqu√≠ para ayudarte con cualquier cosa que necesites. " .
               "Puedo contarte sobre nuestra comunidad, revisar estad√≠sticas, o simplemente charlar contigo.\n\n" .
               "üîç **Algunas cosas en las que soy especialmente bueno:**\n" .
               "‚Ä¢ Informaci√≥n sobre nuestros usuarios\n" .
               "‚Ä¢ Estado y estad√≠sticas de la plataforma\n" .
               "‚Ä¢ Datos actualizados del sistema\n" .
               "‚Ä¢ ¬°Y cualquier duda que tengas!\n\n" .
               "¬øPodr√≠as contarme un poco m√°s sobre lo que buscas? Me encanta poder ayudar üòä";
    }

    /**
     * Obtener datos de contexto basados en la pregunta
     */
    private function getContextData(string $question): array
    {
        $contextData = [];
        $questionLower = strtolower($question);

        // Si pregunta sobre usuarios
        if (str_contains($questionLower, 'usuario') || str_contains($questionLower, 'user')) {
            $contextData['users'] = [
                'total' => User::count(),
                'active' => User::whereNotNull('email_verified_at')->count(),
                'recent' => User::where('created_at', '>=', now()->subDays(7))->count(),
            ];

            // Si pregunta espec√≠ficamente por correos o emails
            if (str_contains($questionLower, 'correo') || str_contains($questionLower, 'email') || str_contains($questionLower, 'mail')) {
                $contextData['user_emails'] = User::select('name', 'email', 'email_verified_at')
                    ->get()
                    ->map(function($user) {
                        return [
                            'name' => $user->name,
                            'email' => $user->email,
                            'verified' => $user->email_verified_at ? 'S√≠' : 'No'
                        ];
                    });
            }

            // Si pregunta por nombres o listado completo
            if (str_contains($questionLower, 'nombre') || str_contains($questionLower, 'listado') || str_contains($questionLower, 'lista')) {
                $contextData['user_list'] = User::select('name', 'email', 'created_at')
                    ->get()
                    ->map(function($user) {
                        return [
                            'name' => $user->name,
                            'email' => $user->email,
                            'registered' => $user->created_at->format('d/m/Y')
                        ];
                    });
            }
        }

        // Si pregunta sobre estad√≠sticas generales
        if (str_contains($questionLower, 'estadistic') || str_contains($questionLower, 'total') || str_contains($questionLower, 'cuant')) {
            $contextData['statistics'] = [
                'total_users' => User::count(),
                'verified_users' => User::whereNotNull('email_verified_at')->count(),
                'unverified_users' => User::whereNull('email_verified_at')->count(),
                'recent_registrations' => User::where('created_at', '>=', now()->subDays(7))->count(),
                'database_tables' => DB::select("SHOW TABLES"),
            ];
        }

        return $contextData;
    }

    /**
     * Construir el prompt con contexto para OpenAI
     */
    private function buildPrompt(string $question, array $contextData): string
    {
        $prompt = "Pregunta del usuario: {$question}\n\n";
        
        if (!empty($contextData)) {
            $prompt .= "Informaci√≥n disponible de la plataforma:\n";
            
            if (isset($contextData['users'])) {
                $users = $contextData['users'];
                $prompt .= "- Total de usuarios registrados: {$users['total']}\n";
                $prompt .= "- Usuarios activos (verificados): {$users['active']}\n";
                $prompt .= "- Usuarios registrados en los √∫ltimos 7 d√≠as: {$users['recent']}\n";
            }

            if (isset($contextData['user_emails'])) {
                $prompt .= "\nListado de correos de usuarios:\n";
                foreach ($contextData['user_emails'] as $user) {
                    $status = $user['verified'] === 'S√≠' ? 'Verificado' : 'No verificado';
                    $prompt .= "- {$user['name']}: {$user['email']} ({$status})\n";
                }
            }

            if (isset($contextData['user_list'])) {
                $prompt .= "\nListado completo de usuarios:\n";
                foreach ($contextData['user_list'] as $user) {
                    $prompt .= "- {$user['name']} ({$user['email']}) - Registrado: {$user['registered']}\n";
                }
            }

            if (isset($contextData['statistics'])) {
                $stats = $contextData['statistics'];
                $prompt .= "- Total de usuarios en la plataforma: {$stats['total_users']}\n";
                $prompt .= "- Usuarios verificados: {$stats['verified_users']}\n";
                $prompt .= "- Usuarios no verificados: {$stats['unverified_users']}\n";
                $prompt .= "- Registros recientes (7 d√≠as): {$stats['recent_registrations']}\n";
            }
            
            $prompt .= "\nPor favor, responde la pregunta bas√°ndote en esta informaci√≥n.";
        } else {
            $prompt .= "\nNo tengo informaci√≥n espec√≠fica sobre este tema en la base de datos actual.";
        }

        return $prompt;
    }

    /**
     * Obtener informaci√≥n sobre Capi
     */
    public function about()
    {
        return response()->json([
            'name' => 'Capi',
            'title' => 'Mascota oficial de INSECAP',
            'description' => 'Soy Capi, la mascota de INSECAP y tu compa√±ero digital. Me crearon para ayudarte con todo lo que necesites en nuestra plataforma, como si fu√©ramos amigos charlando.',
            'personality' => 'Amigable, conversacional y siempre dispuesto a ayudar',
            'organization' => 'INSECAP',
            'capabilities' => [
                'Conversar de manera natural y amigable',
                'Consultar estad√≠sticas de usuarios',
                'Proporcionar informaci√≥n sobre la plataforma',
                'Responder preguntas sobre datos almacenados',
                'Ser tu compa√±ero confiable las 24 horas'
            ],
            'version' => '1.0.0',
            'mode' => env('CAPI_DEMO_MODE', true) ? 'demo' : 'openai',
            'status' => 'online',
            'greeting' => '¬°Hola! Soy Capi, la mascota de INSECAP üêæ ¬øEn qu√© puedo ayudarte hoy?'
        ]);
    }
}
